---
title: "Homework 02"
author: "Ihsan Kahveci"
date: "2020-04-18"
output:
  pdf_document:
    latex_engine: xelatex
    highlight: tango
    df_print: kable
    fig_caption: true
---

```{r setup, include=FALSE}

gr <- 2 / (1 + sqrt(5))

knitr::opts_chunk$set(echo = FALSE, fig.asp = gr)
options(knitr.kable.NA = '-')

rm(gr)
```

# Questions

```{r prep, include=FALSE}

# Prep work ---------------------------------------------------------------

# Load libraries
library(tidyverse, quietly = TRUE)
library(demogR) 
library(wpp2019)

# Helper functions

write_matex <- function(x, digits = 3) {
  # From: https://stackoverflow.com/a/54088015/8866058
  x <- round(x, digits = digits)
  mat_string <- apply(x, 1, function(y) paste(y, collapse = "&"))
  paste("\\begin{bmatrix}", paste0(mat_string, collapse = "\\\\"), "\\end{bmatrix}")
}

"%^%" <- function(A, n) {
  if (n == 1) {
    A
  } else {
    A %*% (A %^% (n - 1))
  }
}

make_leslie_matrix <- function(f, s) {

  if (length(f) != length(s)) {
    stop("f and s must be the same length")
  }

  n_size <- length(f)
  l_mat <- matrix(0, nrow = n_size, ncol = n_size)

  l_mat[1, ] <- f
  diag(l_mat[-1, ]) <- s[1:(n_size - 1)]
  l_mat[n_size, n_size] <- s[n_size]

  l_mat
}

```


## _Q1_

```{r}

# Question 1 --------------------------------------------------------------

pop_table <- tibble(
  age = c("1", "2", "3+"),
  pop = c(18, 17, 14) * 1000,
  fr = c(0, .9, .2),
  surv = c(.65, .75, .15)
)

knitr::kable(
  pop_table,
  booktabs = TRUE,
  caption = "Q1 one-sex closed population",
  col.names = c(
    "Age",
    "Population ($N_x$)",
    "Fertility Rate ($\\tilde{F}_x$)",
    "Survival Prob. ($s_x$)"
  ),
  eval = FALSE
)

```


### _Q1.a_

```{r}

# Question 1a -------------------------------------------------------------

CBR <- pop_table %>%
  mutate(births = pop * fr,
         person_years = pop * surv) %>%
  summarise(cbr = sum(births) / sum(person_years)) %>%
  pull(cbr)

```

The crude birth rate ($CBR$) is defined as the number of births over the
person-years lived in the period $[T_1, T_2]$. Since our period is a single
year, we can calculate $CBR$ as:

$$
CBR = \sum\frac{N_x \tilde{F}_x}{N_xs_x}
$$

where we sum over all age groups. The crude birth rate for this population in
the next time period is then **`r round(CBR, 3)`**.


### _Q1.b_

```{r}
# Question 1b -------------------------------------------------------------
## function for convertion fertility rate to expected number of female births
f_tilde_2_asfr <- function(F_tilde, srb, Sxm1, Nxm1, Nx, q0) {
  F_tilde * (1 + srb) * 2/(1 + Sxm1 * (Nxm1/Nx)) / (1 - q0/2)}

pop_asfr_1 <- 0
pop_asfr_2 <- f_tilde_2_asfr(0.9, 1.05, .65, 18000, 17000, 1 - 0.65)
pop_asfr_3 <- f_tilde_2_asfr(0.2, 1.05, .75, 17000, 14000, 1 - 0.65)

pop_asfr <- c(pop_asfr_1, pop_asfr_2, pop_asfr_3)

TFR <- sum(pop_asfr)
tfr_eqn <- paste0(round(pop_asfr, 3), collapse = " + ")

```


The total fertility rate in the population in the period $[T_1, T_2]$ is
defined as the sum of the age-specific fertility rates across all age groups,
multiplied by the length of the age interval, $n$. With $T_2 - T_1 = n = 1$,
the total fertility rate represents the single-year cohort total fertility rate:

$$
\text{TFR}[T_1, T_1 + 1] = \sum {}_{1}F_{x}[T_1, T_1 + 1]
$$

We can convert between $\tilde{F}_x$ and ${}_{1}F_{x}$ using the equation

$$
\tilde{F}_x = {}_{1}F_{x} \times
\frac{1}{1 + SRB} \times
\frac{1}{2}\left( 1 + s_{x-1} \frac{N_{x-1,t}}{N_{x,t}} \right) \times
\left( 1 - \frac{q_0}{2} \right)
$$

where we assume $SRB = 1.05$ and take $q_0 = 1 - s_0$. After converting to
age-specific fertility rates, we calculate a total fertility rate of
$`r tfr_eqn` =$ **`r round(TFR, 3)`** for this population.


### _Q1.c_

```{r}

# Question 1c -------------------------------------------------------------

pop_leslie <- make_leslie_matrix(pop_table$fr, pop_table$surv)
```

The Leslie matrix, $L$, for this population is defined as:

$$
L =
\begin{bmatrix}
\tilde{F}_{A-3} & \tilde{F}_{A-2} & \tilde{F}_{A-1} \\
s_{A-3}         & 0               & 0 \\
0               & s_{A-2}         & s_{A-1}
\end{bmatrix}
= `r write_matex(pop_leslie)`
$$

Where $(A-1)+$ is the highest age group that can be reached in this population,
$3+$, $s_x$ denotes the probability of survival to the next age group for age
group $x$, and $\tilde{F}_{x}$ is the expected number of female births to a
woman age $x$, who survives to the next time interval.


### _Q1.d_

```{r}

# Question 1d -------------------------------------------------------------

pop_t0 <- matrix(pop_table$pop)
pop_t1 <- pop_leslie %*% pop_t0

```


We can project this population forward using the _cohort-component method of
population projection_, which states that the age-specific populations one time
period ahead ($N_{t+1}$) can be calculated from the matrix multiplication of the
age-specific population in the current period ($N_t$) and the Leslie matrix
($L$) of the population. The population by age one period forward from our
given initial population is then:

$$
\begin{aligned} N_{t+1} &= L N_t \\
&= `r write_matex(pop_leslie)` `r write_matex(pop_t0)` \\
&= `r write_matex(pop_t1)`
\end{aligned}
$$


### _Q1.e_

```{r}

# Question 1e -------------------------------------------------------------
pop_t2 <- (pop_leslie %^% 2) %*% pop_t0

```

This method can be extended to projecting age-specific population $k$ periods
ahead by raising the Leslie matrix to the $k^{\text{th}}$ power ($L^k$). Our
given population, projected $2$ periods into the future is then:

$$
\begin{aligned} N_{t+2} &= L^{10} N_t \\
&= `r write_matex(pop_leslie)`^{2} `r write_matex(pop_t0)` \\
&= `r write_matex(pop_leslie %^% 2)` `r write_matex(pop_t0)` \\
&= `r write_matex(pop_t2)`
\end{aligned}
$$


### _Q1.f_

```{r}

# Question 1f -------------------------------------------------------------

CBR_t2 <- pop_table %>%
  mutate(
    pop = as.vector(pop_t1),
    births = pop * fr,
    person_years = pop * surv
  ) %>%
  summarise(cbr = sum(births) / sum(person_years)) %>%
  pull(cbr)

pop_asfr_t2_1 <- 0
pop_asfr_t2_2 <- f_tilde_2_asfr(0.9, 1.05, .65, pop_t1[1], pop_t1[2], 1 - 0.65)
pop_asfr_t2_3 <- f_tilde_2_asfr(0.2, 1.05, .75, pop_t1[2], pop_t1[3], 1 - 0.65)

pop_asfr_t2 <- c(pop_asfr_t2_1, pop_asfr_t2_2, pop_asfr_t2_3)

TFR_t2 <- sum(pop_asfr_t2)
tfr_eqn_t2 <- paste0(round(pop_asfr_t2, 3), collapse = " + ")


```

The crude birth rate for this population from time period 1 to time period 2 is
**`r round(CBR_t2, 3)`**.

The total fertility rate between time periods 1&2 is $`r tfr_eqn_t2` = $ **`r round(TFR_t2, 3)`** for this population. 

### _Q1.g_

```{r}

# Question 1g -------------------------------------------------------------

pop_right_eigen <- eigen(pop_leslie)
dominant_right_index <- which.max(abs(pop_right_eigen$values))

pop_iroi <- log(pop_right_eigen$values[dominant_right_index])

```

From the theorem that $N_t$ converges to $\lambda^t u$ as $t$ approaches
infinity, $log(\lambda)$ is the _instantaneous rate of increase of the
population_. Here, $\lambda$ is defined as the dominant **right eigenvalue** of the
Leslie matrix, or for the equation:

$$
Lv = \lambda v
$$

it is the eigenvalue $\lambda$ with the largest magnitude. For our calculated
Leslie matrix, the instantaneous rate of increase is **`r round(pop_iroi, 3)`.**

### _Q1.h_

```{r}

# Question 1h -------------------------------------------------------------

pop_sad <- matrix(pop_right_eigen$vectors[, dominant_right_index])

```

Again, from the the formula $\lambda^t u$, $u$ is the _stable age distribution_,
and is defined as the dominant **right eigenvector** of the Leslie matrix, which is
the column vector $v$ from the eigendecomposition of $L$ corresponding to the
eigenvalue $\lambda$ with the largest magnitude.

For our calculated Leslie matrix, the stable age distribution is
$`r write_matex(pop_sad)`$.


### _Q1.i_

```{r}

# Question 1i -------------------------------------------------------------

pop_left_eigen <- eigen(t(pop_leslie))
dominant_left_index <- which.max(abs(pop_left_eigen$values))

pop_repv <- matrix(pop_left_eigen$vectors[, dominant_left_index])

```

The reproductive value vector ($v$) is a vector of expected the number of future
offspring of an individual for each age group. A theorem states that $v$ is
the dominant **left eigenvector** of the Leslie matrix for the population. The left
dominant eigenvector of a matrix $A$ is equivalent to the right dominant
eigenvector of the transpose of matrix, $A^\top$. So, in the formula:

$$ L^{\top}u = \kappa u $$

the dominant eigenvector $u$ represents the reproductive values. For our Leslie
matrix, the reproductive value matrix is then $`r write_matex(pop_repv)`$.


\newpage


## _Q2_
### _Q2.a_

```{r}
# Question 2 ---------------------------------------------------------------
## Question 2a -------------------------------------------------------------
data(mxF)
peru_mx <- mxF %>%
  filter(name == "Peru") %>%
  select(age, mx = `2015-2020`)

# Builds a life table by using the mortality rate 
peru_LT = 
  LifeTables::lt.mx(peru_mx$mx, age = peru_mx$age)$lt %>% 
  as_tibble() %>%
  mutate(age = 
           paste0(Age, "-", Age + 4) %>% 
           magrittr::inset(c(1, 2, length(Age)), c("0", "1-4", "100+")), .before=1)

peru_mx %>% 
  knitr::kable(
  booktabs = TRUE,
  escape = TRUE,
  digits = 3,
  col.names = c("Age", "$_nq_x$"),
  eval = FALSE,
  caption = "Age-specific Mortality Rates of Peru female population, 2015-2020")

```


### _Q2.b_

First, we need to calculate a life table from mortality rates. 

```{r, warning=FALSE}
# Question 2b -------------------------------------------------------------
LT_colnames <- c(
  "Age",
  "$a_x$",
  "$_{5}m_x$",
  "$_{1}q_x$",
  "$_{1}s_x$",
  "$_{5}d_x$",
  "$l_x$",
  "${}_{5}L_x$",
  "${}_{5}T_x$",
  "$e_x$"
)

peru_LT %>% 
  select(-Age)  %>%
  knitr::kable(
    booktabs = TRUE,
    col.names = LT_colnames,
    eval = FALSE,
    digits = c(0, 1, 3, 3, 3, 0, 0, 2, 0, 0, 2),
    caption = "Life table for 2015-2020 Peru female population")


# Create standard 5-year age goup npx and nqx mortality
peru_0_to_5 =peru_LT %>%
  filter(Age < 5) %>%
  summarise(age = "0-4", nqx = 1 - prod(npx), npx = prod(npx))

peru_q0 <- peru_0_to_5$nqx[1]

peru_nqx <- peru_LT %>% 
  filter(Age >= 5) %>%
  select(age, nqx, npx) %>% 
  bind_rows(peru_0_to_5, .)


peru_nqx%>% 
  knitr::kable(
    booktabs = TRUE,
    col.names = c("Age", "$_nq_x$", "$_ns_x$"),
    eval = FALSE,
    digits = c(0, 2, 2),
    caption = "Peru $_ns_x$: 0 and 1-4 combined")
```

Then, we will use, we will use $_ns_x$ and $q_0$ values to convert between $\tilde{F}_x$ and ${}_{1}F_{x}$ using the equation.

```{r, warning=FALSE}
data(popF)
data(sexRatio)
data(tfr)
data(percentASFR)

peru_pop <- popF %>% 
  filter(name == "Peru") %>% 
  select(age, pop = `2015`) %>% 
  mutate(order = row_number())

peru_srb <- sexRatio %>% filter(name == "Peru") %>% pull(`2015-2020`)
peru_tfr <- tfr %>% filter(name == "Peru") %>% pull(`2015-2020`)

asfr_2_f_tilde <- function(asfr, srb, Sxm1, Nxm1, Nx, q0) {
  asfr * (1 / (1 + srb)) * .5 * (1 + Sxm1 * (Nxm1 / Nx)) * (1 - q0 / 2)}

peru_Fx <- percentASFR %>%
  filter(name == "Peru") %>%
  select(age=age, pasfr = `2015-2020`) %>%
  mutate(asfr = pasfr * peru_tfr / 5) %>%
  right_join(peru_pop, by = "age", ) %>%
  replace_na(list(pasfr = 0, asfr = 0)) %>%
  left_join(peru_nqx, by = "age") %>%
  mutate(
    f_tilde =
      asfr_2_f_tilde(asfr, peru_srb, lag(npx), lag(pop), pop, peru_q0)
  ) %>%
  replace_na(list(f_tilde = 0)) %>%
  arrange(order) %>%
  select(-order)

```

To calculate ${}_{5}\tilde{F}_x$, we first use the provided proportional
age-specific fertility rate and total fertility rate for Peru in 2015 to get
age-specific fertility rate with the formula:

$$ \frac{TFR[T_1, T_2] \times {}_{n}PASFR_x}{n} = {}_{n}F_x[T_1, T_2] $$

where $n = 5$ and $[T_1, T_2] = [2015, 2020]$. Then we use the provided
population and previously calculated mortality rates ${}_{5}s_x$ and ${}_{5}q_0$
to calculate ${}_{5}\tilde{F}_x$ using the formula:

$$
{}_{n}\tilde{F}_x = {}_{n}F_x \times
\frac{1}{1 + SRB} \times
\frac{1}{2} \left( 1 + {}_{n}s_x \frac{{}_{5}N_{x-1,t}}{{}_{5}N_{x,t}} \right) \times
\left( 1 - \frac{{}_{n}q_0}{2} \right)
$$

Note that ${}_{5}q_0$ was calculated as $1 - {}_{5}s_0$, which was in turn
calculated from ${}_{1}s_0 \times {}_{4}s_1$.

With these calculations, our resulting ${}_{5}\tilde{F}_x$ is:

```{r}
knitr::kable(
  select(peru_Fx, age, f_tilde, asfr, pop, npx),
  booktabs = TRUE,
  col.names =
    c("Age", "${}_{5}\\tilde{F}_x$", "${}_{5}F_x$", "${}_{5}N_x$", "${}_{5}s_x$"),
  eval = FALSE,
  digits = c(0, 3, 3, 0, 3),
  caption = paste(
    "Expected number of live female births per woman per five-year period",
    "in Peru, 2015-2020"
  )
)
```


### _Q2.c_

### _Q2.d_

### _Q2.e_



# Appendix

```{r getlabels, include=FALSE}
labs <- knitr::all_labels()
labs <- labs[!labs %in% c("setup", "toc", "getlabels", "allcode")]
```

```{r allcode, ref.label=labs, eval=FALSE, echo=TRUE}
```
